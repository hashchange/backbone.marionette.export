// Backbone.Marionette.Export, v1.0.1
// Copyright (c)2014 Michael Heim, Zeilenwechsel.de
// Distributed under MIT license
// http://github.com/hashchange/backbone.marionette.export

!function(a,b){if("object"==typeof exports){var c=require("underscore"),d=require("backbone"),e=require("marionette");module.exports=b(c,d,e)}else"function"==typeof define&&define.amd&&define(["underscore","backbone","marionette"],b)}(this,function(a,b){"option strict";return function(a,b){"use strict";function c(a){var c,d=[];for(c=a;null!==c;c=Object.getPrototypeOf(c))d=d.concat(Object.getOwnPropertyNames(c));return b.unique(d)}var d=c([]);a.Model.prototype.onBeforeExport=a.Collection.prototype.onBeforeExport=function(){},a.Model.prototype.onAfterExport=a.Collection.prototype.onAfterExport=function(){},a.Model.prototype.onExport=a.Collection.prototype.onExport=function(a){return a},a.Model.prototype.export=a.Collection.prototype.export=function(){function c(b){return b&&b.export&&(b instanceof a.Model||b instanceof a.Collection)&&h<b.export.maxHops}var e,f,g,h;if(h=arguments.length?arguments[0]:0,this.onBeforeExport&&this.onBeforeExport(),this instanceof a.Collection?e=this.map(function(a){return c(a)?a.export(h+1):a}):b.cloneDeep?e=b.cloneDeep(this.attributes,function(a){return c(a)?a.export(h+1):void 0}):(e=this.toJSON(),b.each(e,function(a,b,d){c(a)&&(d[b]=a.export(h+1))})),this.exportable&&(f=this.exportable,b.isArray(f)||(f=f?[f]:[]),b.each(f,function(d){var f;if(b.isUndefined(d))throw new Error("Can't export method. Undefined method reference");if(!b.isString(d))throw new Error("'exportable' property: Invalid method identifier");if(f=0===d.indexOf("this.")?d.substr(5):d,!this[f])throw new Error("Can't export \""+f+"\". The method doesn't exist");if(d=this[f],b.isFunction(d))e[f]=d.apply(this);else{if(this instanceof a.Model)throw new Error("'exportable' property: Invalid method identifier \""+f+'", does not point to a function');e[f]=this[f]}b.cloneDeep?e[f]=b.cloneDeep(e[f],function(a){return c(a)?a.export(h+1):void 0}):c(e[f])&&(e[f]=e[f].export(h+1))},this)),this.onExport&&(e=this.onExport(e)),this.onAfterExport&&this.onAfterExport(),this instanceof a.Collection&&(g=b.intersection(d,b.keys(e)),g.length))throw new Error("Can't export a property with a name which is reserved for a native array property. Offending properties: "+g);return e},a.Model.prototype.export.maxHops=a.Collection.prototype.export.maxHops=4,a.Marionette&&(a.Marionette.ItemView.prototype.serializeData=a.Marionette.CompositeView.prototype.serializeData=function(){var a={};return this.model?a=this.model.export&&this.model.export()||this.model.toJSON():this.collection&&(a={items:this.collection.export&&this.collection.export()||this.collection.toJSON()}),a})}(b,a),b.Marionette.Export});